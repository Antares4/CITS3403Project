{% extends 'content.html'%}
{% block page %}
<!-- this is the interesting one -->
<!-- each module needs to take up the entire page -->

<!-- intro module will be displayed at the beginning-->
<div class="textcontainer content-section">
<div id="intro">
    <div>
        <!-- header -->
        <h1>Key Reaction test</h1>
        <!--  -->
        <p>
            <!-- make this eye catching, espically the "30"  -->
            In this test you will have <strong>30</strong> seconds to test your familiraty with Key recognition. 
        </p>
    </div>
    <!-- make this button bigger and  -->
    <button id="start">Start</button>
</div>
<!--  -->

<!-- Start button triggers display of this module which will also take up the whole page-->
<div id="content" style="display: none;">
    <h1>Key Reaction test</h1>
    <!-- you need to impliment either a text timer e.g 1:30 or a css graphic one which ever one you prefer -->
    <span id="timer">timer</span>
    <!--  -->
    <div id="score">0</div>
    <!-- this div you can use to position the stave -->
    <div>

        <!-- do not touch !!!!! -->
        <div class="stave" id="note"></div>
        <!-- do not touch !!!!! -->

    </div>
    <!--  -->

    <!-- these two buttons needs to be large to be clicked on easily -->
    <!-- please use contrasting color -->
    <button id="btn-1">button1</button>
    <button id="btn-2">button2</button>
    <!--  -->
</div>
<!--  -->

<!-- this is the last module that will display when the test finshes  -->
<div id="review" style="display: none;">
    <h1 id="record"></h1>
    <span>you have received: </span>
    <!-- do not change the id -->
    <span id="score"></span>

    <!--  -->
    <span> Marks!</span>
    <hr>
    <span>Highest score:</span> 
    <span id="highscore"></span>
    <hr>
    <span>Current Ranking:</span>
    <span id="ranking"></span>
    <hr>
    <span>View full result and ranking, click <a href="{{url_for('index.profile', userId=current_user.id)}}">Here</a></span>
</div>
</div>
<!--  -->

<script type=text/javascript>
    // game logic do not modify!!!!!
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    $(document).ready(function(){
        var rightAnswer = null;
        var canidateLiterals = [["C","C"],["F","F"],["B","B"],["Eb","E flat"],
                                ["Ab","A flat"],["Db","D flat"],["Gb","G flat"],
                                ["Cb","C flat"],["G","G"],["D","D"],["A","A"],
                                ["E","E"],["B","B"],["F#","F sharp"],["C#","C sharp"]]
        var currentpair = [];
        var correctanswer = null;
        var this_clef = null;
        var points = 0;
        var timeLeft = 30;
        var userId = {{ current_user.id|safe }}
        var time_div = document.getElementById("timer");
        var score = document.getElementById("score");
        $("#start").bind("click",function(){
            // do not modify
            $("#intro").css("display","none")
            $("#content").css("display","block")
            // do not modify

            //####### Shuang this is for you ##########
            // this is the time out callback i've set when start is pressed try impliment a countdown using js or css or both 

            timer = setInterval(countdown, 1000);
            //###############################

            // do not modify
            this_clef = getRandomClef()
            setAnswers(this_clef);
            // do not modify
        })
        // do not modify
        $("#btn-1").bind("click",function(){
            if(event.target.innerHTML == correctanswer[1]){
                points++;
            }
            else{
                if(points > 0){
                    points--;
                }
            }
            score.innerHTML = points;
            removestave("note");
            this_clef = getRandomClef()
            setAnswers(this_clef);
        })
        // do not modify
        
        // do not modify
        $("#btn-2").bind("click",function(){
            if(event.target.innerHTML == correctanswer[1]){
                points++;
            }
            else{
                if(points > 0){
                    points--;
                }
            }
            score.innerHTML = points;
            removestave("note");
            this_clef = getRandomClef()
            setAnswers(this_clef);
        })
        // do not modify
        function setAnswers(clef){
            canidates = getRandomCanidate(15);
            currentpair[0] = canidateLiterals[canidates[0]];
            currentpair[1] = canidateLiterals[canidates[1]];
            //0 is always correct answer
            correctanswer = currentpair[0];
            btn_assign = Math.round(Math.random())
            btn_assign == 0 ? btnAssingInOrder("btn-1","btn-2",currentpair) : btnAssignReOrder("btn-1","btn-2",currentpair)
            renderStaveKeys("note",this_clef,currentpair[0][0]);
        }
        function timeOutSubmit(){
            $.getJSON($SCRIPT_ROOT + '/timedKey', {
                score: points,
                user : userId
                }, function(data) {
                $("#content").css("display","none")
                $("#review").css("display","block")
                if(data.record == true){
                    document.getElementById("record").innerHTML = "New Record!"
                }
                document.getElementById("highscore").innerHTML = data.HighScore
                document.getElementById("ranking").innerHTML = data.ranking;
                document.getElementById("score").innerHTML = data.score;
            }) 
        }
        function countdown(){
            if (timeLeft == -1) {
                clearTimeout(timer);
                timeOutSubmit();
            } 
            else {
                time_div.innerHTML = timeLeft + ' seconds remaining';
                timeLeft--;
            }
        }
    });
    // gmae logic do not modify!!!!!
  </script>
{% endblock %}